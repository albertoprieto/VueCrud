import{u as J}from"./useVentas-BawyIJMQ.js";import{_ as j,r as p,ab as K,e as c,i as z,w as v,a as n,b as i,u as e,B as A,x as F,s as g,h as G,g as w,k as X,z as L,c as b,j as B,t as m,f as D,F as q,G as H}from"./index-CtvM3DNL.js";import"./clientesService-D1JrjMGd.js";import"./ventasService-wEParwlm.js";import"./articulosService-owItUeAv.js";const Q={class:"ventas-form-header"},R={class:"ventas-form-col"},W={class:"ventas-form-col"},Y={class:"mb-2"},Z={class:"modal-actions"},P={__name:"EditarVenta",props:{venta:Object,clientes:Array},emits:["cerrar","guardar"],setup(M,{emit:N}){const k=M,_=N,{articulosConStock:h,getStockDisponible:T,imeisDisponiblesPorArticulo:U,mostrarColumnaIMEI:S,validateCantidad:E,onArticuloChange:O}=J(),V=p(!0);function I(d){return d?/^\d{4}-\d{2}-\d{2}$/.test(d)?d:typeof d=="string"&&(d.includes(" ")||d.includes("T"))?d.split(/[ T]/)[0]:d instanceof Date?d.toISOString().slice(0,10):d:""}const r=p({...k.venta,fecha:I(k.venta.fecha),detalle:k.venta.detalle?JSON.parse(JSON.stringify(k.venta.detalle)):[]});console.log("Fecha inicial recibida:",k.venta.fecha),console.log("ventaEdit inicial:",r.value),K(()=>k.venta,d=>{console.log("Prop venta actualizada:",d),r.value={...d,fecha:I(d.fecha),detalle:d.detalle?JSON.parse(JSON.stringify(d.detalle)):[]},console.log("ventaEdit después de update:",r.value)});function $(){_("guardar",{...r.value}),x()}function x(){V.value=!1,_("cerrar")}return(d,s)=>(c(),z(e(X),{visible:V.value,"onUpdate:visible":s[3]||(s[3]=l=>V.value=l),header:"Editar Nota de Venta",modal:!0,class:"ventas-dialog"},{default:v(()=>[n("div",Q,[n("div",R,[s[4]||(s[4]=n("label",{class:"mb-2"},"Cliente",-1)),i(e(A),{modelValue:r.value.cliente_id,"onUpdate:modelValue":s[0]||(s[0]=l=>r.value.cliente_id=l),options:M.clientes,optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona un cliente",class:"w-full",disabled:""},null,8,["modelValue","options"])]),n("div",W,[s[5]||(s[5]=n("label",null,"Fecha",-1)),i(e(F),{modelValue:r.value.fecha,"onUpdate:modelValue":s[1]||(s[1]=l=>r.value.fecha=l),type:"date",class:"fecha-input"},null,8,["modelValue"])])]),n("div",Y,[s[6]||(s[6]=n("label",null,"Observaciones",-1)),i(e(F),{modelValue:r.value.observaciones,"onUpdate:modelValue":s[2]||(s[2]=l=>r.value.observaciones=l),class:"w-full"},null,8,["modelValue"])]),s[7]||(s[7]=n("h3",null,"Artículos",-1)),i(e(G),{value:r.value.detalle,responsiveLayout:"scroll",class:"venta-articulos-table"},{default:v(()=>[i(e(g),{header:"Artículo"},{body:v(l=>[i(e(A),{modelValue:l.data.articulo_id,"onUpdate:modelValue":f=>l.data.articulo_id=f,options:e(h)(l.data),optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona artículo",class:"w-full",onChange:f=>e(O)(l.data.articulo_id,l.data),disabled:!0},null,8,["modelValue","onUpdate:modelValue","options","onChange"])]),_:1}),i(e(g),{header:"Cantidad"},{body:v(l=>[i(e(F),{type:"number",modelValue:l.data.cantidad,"onUpdate:modelValue":f=>l.data.cantidad=f,modelModifiers:{number:!0},min:1,max:e(S)(l.data.articulo_id)?1:e(T)(l.data.articulo_id,l.data),class:"w-full",disabled:e(S)(l.data.articulo_id),onInput:f=>e(E)(l.data)},null,8,["modelValue","onUpdate:modelValue","max","disabled","onInput"])]),_:1}),i(e(g),{header:"Precio"},{body:v(l=>[i(e(F),{type:"number",modelValue:l.data.precio_unitario,"onUpdate:modelValue":f=>l.data.precio_unitario=f,modelModifiers:{number:!0},min:"0",step:"0.01",class:"w-full"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(e(g),{header:"IMEI"},{body:v(l=>[i(e(A),{modelValue:l.data.imei,"onUpdate:modelValue":f=>l.data.imei=f,options:[...e(U)(l.data.articulo_id,l.data)||[],...l.data.imei?[{imei:l.data.imei}]:[]],optionLabel:"imei",optionValue:"imei",placeholder:"Selecciona IMEI",class:"w-full",disabled:!l.data.articulo_id},null,8,["modelValue","onUpdate:modelValue","options","disabled"])]),_:1})]),_:1},8,["value"]),n("div",Z,[i(e(w),{label:"Guardar",icon:"pi pi-save",onClick:$}),i(e(w),{label:"Cancelar",icon:"pi pi-times",class:"p-button-secondary",onClick:x})])]),_:1},8,["visible"]))}},ee=j(P,[["__scopeId","data-v-99431755"]]),ae={class:"consultar-ventas"},le={class:"filtros"},te={key:0},ne={key:1},oe={key:0},ie={key:1},de={key:0,class:"detalle-venta-dialog"},se={class:"mb-2"},ue={class:"detalle-table"},re={key:0},ce={key:0},ve={class:"detalle-venta-footer"},me={class:"detalle-total"},pe={key:1},fe={__name:"consultarVentas",setup(M){const{ventas:N,cargarDetalleVenta:k,detalleVenta:_}=J(),h=p(""),T=p(null),U=p(null),S=p("");p([]),p([]);const E=p(!1),O=p(null),V=p(null),I=p(""),r=L(()=>N.value.filter(t=>{var u;const a=!h.value||((u=t.cliente_nombre)==null?void 0:u.toLowerCase().includes(h.value.toLowerCase())),o=!U.value||t.telefonos&&t.telefonos.some(C=>C.includes(U.value)),y=!S.value||t.detalle&&t.detalle.some(C=>C.imei&&(C.imei.includes(S.value)||C.imei.slice(-5)===S.value));return a&&o&&y}));function $(t){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(Number(t)||0)}function x(t){return t?/^\d{4}-\d{2}-\d{2}$/.test(t)?t:typeof t=="string"&&(t.includes(" ")||t.includes("T"))?t.split(/[ T]/)[0]:t instanceof Date?t.toISOString().slice(0,10):t:""}async function d(t){O.value=t,await k({data:t}),E.value=!0}async function s(t){await k({data:t}),V.value={...t,detalle:_.value?JSON.parse(JSON.stringify(_.value)):[]},I.value=t.fecha?t.fecha.split(/[ T]/)[0]:""}function l(){V.value=null,I.value=""}const f=()=>{h.value="",T.value=null,U.value=null,S.value=""};return L(()=>{const t=new Set;return N.value.forEach(a=>(a.usuarios||[]).forEach(o=>t.add(o))),Array.from(t).map(a=>({label:a,value:a}))}),L(()=>{const t=new Set;return N.value.forEach(a=>(a.telefonos||[]).forEach(o=>t.add(o))),Array.from(t).map(a=>({label:a,value:a}))}),(t,a)=>(c(),b("div",ae,[a[11]||(a[11]=n("h2",null,"Consultar Notas de Venta",-1)),n("div",le,[i(e(F),{modelValue:h.value,"onUpdate:modelValue":a[0]||(a[0]=o=>h.value=o),placeholder:"Buscar por cliente...",class:"mb-2 filtro-input",clearable:""},null,8,["modelValue"]),i(e(w),{label:"Limpiar",icon:"pi pi-times",class:"p-button-secondary",onClick:f})]),i(e(G),{value:r.value},{default:v(()=>[i(e(g),{field:"cliente_nombre",header:"Cliente"}),i(e(g),{field:"telefonos",header:"Teléfonos"},{body:v(o=>[o.data.telefonos&&o.data.telefonos.length?(c(),b("span",te,m(o.data.telefonos.join(", ")),1)):(c(),b("span",ne,"-"))]),_:1}),i(e(g),{field:"fecha",header:"Fecha"},{body:v(o=>[D(m(x(o.data.fecha)),1)]),_:1}),i(e(g),{field:"total",header:"Total"},{body:v(o=>[D(m($(o.data.total)),1)]),_:1}),i(e(g),{field:"imeis",header:"IMEIs"},{body:v(o=>[o.data.detalle&&o.data.detalle.length?(c(),b("span",oe,m(o.data.detalle.filter(y=>y.imei).map(y=>y.imei).join(", ")),1)):(c(),b("span",ie,"-"))]),_:1}),i(e(g),{header:"Acciones"},{body:v(o=>[i(e(w),{label:"Editar",icon:"pi pi-pencil",class:"p-button-text",onClick:y=>s(o.data)},null,8,["onClick"]),i(e(w),{label:"Ver Detalle",icon:"pi pi-eye",class:"p-button-text",onClick:y=>d(o.data)},null,8,["onClick"])]),_:1})]),_:1},8,["value"]),i(e(X),{visible:E.value,"onUpdate:visible":a[2]||(a[2]=o=>E.value=o),header:"Detalle de Venta",modal:!0},{default:v(()=>{var o,y;return[e(_)&&e(_).length?(c(),b("div",de,[n("div",se,[a[3]||(a[3]=n("strong",null,"Fecha de nota:",-1)),D(" "+m(x((o=O.value)==null?void 0:o.fecha)||"Sin fecha"),1)]),n("table",ue,[n("thead",null,[n("tr",null,[a[4]||(a[4]=n("th",null,"Artículo",-1)),a[5]||(a[5]=n("th",null,"Cantidad",-1)),a[6]||(a[6]=n("th",null,"Precio",-1)),a[7]||(a[7]=n("th",null,"Subtotal",-1)),e(_).some(u=>u.imei)?(c(),b("th",re,"IMEI")):B("",!0)])]),n("tbody",null,[(c(!0),b(q,null,H(e(_),u=>(c(),b("tr",{key:u.id},[n("td",null,m(u.articulo_nombre),1),n("td",null,m(u.cantidad),1),n("td",null,m($(u.precio_unitario)),1),n("td",null,m($(u.cantidad*u.precio_unitario)),1),u.imei?(c(),b("td",ce,m(u.imei),1)):B("",!0)]))),128))])]),n("div",ve,[n("div",null,[a[8]||(a[8]=n("strong",null,"Observaciones:",-1)),D(" "+m(((y=O.value)==null?void 0:y.observaciones)||"Sin observaciones"),1)]),n("div",me,[a[9]||(a[9]=n("strong",null,"Total:",-1)),D(" "+m($(e(_).reduce((u,C)=>u+C.cantidad*C.precio_unitario,0))),1)])])])):(c(),b("div",pe,a[10]||(a[10]=[n("span",null,"No hay detalle disponible.",-1)]))),i(e(w),{label:"Cerrar",onClick:a[1]||(a[1]=u=>E.value.value=!1),class:"detalle-cerrar-btn"})]}),_:1},8,["visible"]),V.value?(c(),z(ee,{venta:V.value,onCerrar:l,key:V.value?V.value.id+"-"+I.value:"empty"},null,8,["venta"])):B("",!0)]))}},ke=j(fe,[["__scopeId","data-v-109eb829"]]);export{ke as default};
