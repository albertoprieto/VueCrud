const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DHBqLVoL.js","assets/index-tIwxuEx6.css"])))=>i.map(i=>d[i]);
import{ar as v,as as $,r as u,at as j,l as A,ag as q,k as z,au as U,n as B}from"./index-DHBqLVoL.js";import{g as F}from"./clientesService-2ylVBQ3J.js";const _="https://64.227.15.111/ventas",G=async()=>(await v.get(_)).data,H=async r=>(await v.post(_,r)).data,J=async r=>(await v.get(`${_}/${r}/detalle`)).data;function W(){const r=$(),l=new Date().toISOString().slice(0,10),m=u([]),c=u([]),g=u([]),y=u(null),I=u([]),d=u([]),h=u(!1),o=j({cliente_id:null,fecha:l,observaciones:"",articulos:[]}),b=A(()=>o.articulos.reduce((i,t)=>i+t.cantidad*t.precio_unitario,0)),D=A(()=>{const i={};return d.value.forEach(t=>{i[t.articulo_nombre]||(i[t.articulo_nombre]=[]),i[t.articulo_nombre].push(t)}),Object.entries(i).map(([t,e])=>({articulo_nombre:t,cantidad:e.length,imeis:e}))});function f(i,t=null){const e=c.value.find(s=>s.id===i);if(!e)return 0;if(e.tipo&&e.tipo.toLowerCase()==="servicio")return null;const n=D.value.find(s=>s.articulo_nombre===e.nombre),a=n?n.cantidad:0,T=o.articulos.filter(s=>s.articulo_id===i&&(!t||s!==t)).reduce((s,R)=>s+R.cantidad,0);return a-T}function M(i=null){return c.value.filter(t=>{if(t.tipo&&t.tipo.toLowerCase()==="servicio")return!0;const e=f(t.id,i);return i&&i.articulo_id===t.id?!0:e>0})}function E(i,t=null){const e=c.value.find(a=>a.id===i);if(!e)return[];const n=o.articulos.filter(a=>a.articulo_id===i&&a.imei&&a!==t).map(a=>a.imei);return d.value.filter(a=>a.articulo_nombre===e.nombre&&a.status==="Disponible"&&!n.includes(a.imei))}function p(i){const t=c.value.find(e=>e.id===i);return!t||t.tipo&&t.tipo.toLowerCase()==="servicio"?!1:E(i).length>0}function k(){o.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function L(i){o.articulos.splice(i,1)}function w(i){const t=c.value.find(e=>e.id===i.articulo_id);if(t&&t.tipo&&t.tipo.toLowerCase()==="servicio"){i.cantidad<1&&(i.cantidad=1);return}if(p(i.articulo_id))i.cantidad=1;else{const e=f(i.articulo_id,i);i.cantidad>e&&(i.cantidad=e),i.cantidad<1&&(i.cantidad=1)}}function P(i,t){const e=c.value.find(n=>n.id===i);e&&(t.precio_unitario=Number(e.precioVenta)||0,t.cantidad=1,t.imei=null)}async function N(){m.value=await F()}async function C(){c.value=await U(()=>import("./index-DHBqLVoL.js").then(i=>i.av),__vite__mapDeps([0,1])).then(i=>i.getTodosArticulos()).then(i=>i||[])}async function V(){d.value=await B()}async function S(){g.value=await G()}async function x(){if(!m.value.some(t=>t.id===o.cliente_id)){r.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const t of o.articulos){const e=c.value.find(n=>n.id===t.articulo_id);if(!e){r.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(!(e.tipo&&e.tipo.toLowerCase()==="servicio")){if(t.cantidad>f(t.articulo_id,t)){r.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(p(t.articulo_id)){if(!t.imei){r.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}const n=o.articulos.filter(a=>a.imei).map(a=>a.imei);if(new Set(n).size!==n.length){r.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}}}try{const t=o.articulos.map(e=>{const n=c.value.find(a=>a.id===e.articulo_id);return n&&n.tipo&&n.tipo.toLowerCase()==="servicio"?{articulo_id:e.articulo_id,cantidad:e.cantidad,precio_unitario:e.precio_unitario}:e.imei?{articulo_id:e.articulo_id,cantidad:1,precio_unitario:e.precio_unitario,imei:e.imei}:{articulo_id:e.articulo_id,cantidad:e.cantidad,precio_unitario:e.precio_unitario}});await H({cliente_id:o.cliente_id,fecha:o.fecha,observaciones:o.observaciones,total:b.value,articulos:t}),h.value=!0,r.add({severity:"success",summary:"Venta registrada",life:3e3}),o.cliente_id=null,o.observaciones="",o.articulos=[],await V(),await C(),await S()}catch{r.add({severity:"error",summary:"Error",detail:"No se pudo registrar la venta.",life:4e3})}}async function O(i){var t;(t=i==null?void 0:i.data)!=null&&t.id&&(I.value=await J(i.data.id),y.value=i.data)}return q(()=>o.articulos.map(i=>i.imei),(i,t)=>{i.forEach((e,n)=>{e&&e!==t[n]&&console.log("IMEI asignado a payload:",e,"en artículo",o.articulos[n])})}),z(()=>{N(),C(),V(),S()}),{today:l,clientes:m,articulosDisponibles:c,ventas:g,ventaSeleccionada:y,detalleVenta:I,imeis:d,showDialog:h,venta:o,totalVenta:b,articulosConStock:M,getStockDisponible:f,imeisDisponiblesPorArticulo:E,mostrarColumnaIMEI:p,addArticulo:k,removeArticulo:L,validateCantidad:w,onArticuloChange:P,guardarVenta:x,cargarDetalleVenta:O}}export{W as u};
