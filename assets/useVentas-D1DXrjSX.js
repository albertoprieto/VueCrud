const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CUS9nlnQ.js","assets/index-tIwxuEx6.css"])))=>i.map(i=>d[i]);
import{ar as A,as as j,r as d,at as F,l as g,ag as G,k as H,au as J,n as K,av as Q}from"./index-CUS9nlnQ.js";import{g as W}from"./clientesService-HEFz_eIw.js";const h="https://64.227.15.111/ventas",X=async()=>(await A.get(h)).data,Y=async n=>(await A.post(h,n)).data,Z=async n=>(await A.get(`${h}/${n}/detalle`)).data;function ei(){const n=j(),m=new Date().toISOString().slice(0,10),p=d([]),c=d([]),I=d([]),b=d(null),E=d([]),f=d([]),S=d(!1),o=F({cliente_id:null,fecha:m,observaciones:"",articulos:[]}),D=g(()=>o.articulos.reduce((i,e)=>i+e.cantidad*e.precio_unitario,0)),k=g(()=>{const i={};return f.value.filter(e=>e.status==="Disponible"||e.status==="Devuelto").forEach(e=>{i[e.articulo_nombre]||(i[e.articulo_nombre]=[]),i[e.articulo_nombre].push(e)}),Object.entries(i).map(([e,a])=>({articulo_nombre:e,cantidad:a.length,imeis:a}))});function v(i,e=null){const a=c.value.find(l=>l.id===i);if(!a)return 0;if(a.tipo&&a.tipo.toLowerCase()==="servicio")return null;const t=k.value.find(l=>l.articulo_nombre===a.nombre),r=t?t.cantidad:0,_=o.articulos.filter(l=>l.articulo_id===i&&(!e||l!==e)).reduce((l,s)=>l+s.cantidad,0);return r-_}function L(i=null){return c.value.filter(e=>{if(e.tipo&&e.tipo.toLowerCase()==="servicio")return!0;const a=v(e.id,i);return i&&i.articulo_id===e.id?!0:a>0})}function P(i,e=null,a=null){const t=c.value.find(s=>s.id===i);if(!t)return[];let r=[];e&&Array.isArray(e.imeis)&&(r=e.imeis.filter((s,$)=>s&&$!==a));const _=o.articulos.filter(s=>s.articulo_id===i&&s!==e&&Array.isArray(s.imeis)).flatMap(s=>s.imeis.filter(Boolean)),l=[...r,..._];return f.value.filter(s=>s.articulo_nombre===t.nombre&&(s.status==="Disponible"||s.status==="Devuelto")&&!l.includes(s.imei))}function y(i,e=null,a=null){const t=c.value.find(r=>r.id===i);return!t||t.tipo&&t.tipo.toLowerCase()==="servicio"?!1:f.value.some(r=>r.articulo_nombre===t.nombre&&(r.status==="Disponible"||r.status==="Devuelto"))}function N(){o.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function x(i){o.articulos.splice(i,1)}function O(i){const e=c.value.find(a=>a.id===i.articulo_id);if(e&&e.tipo&&e.tipo.toLowerCase()==="servicio"){i.cantidad<1&&(i.cantidad=1);return}if(y(i.articulo_id))if(Array.isArray(i.imeis)||(i.imeis=[]),i.cantidad>i.imeis.length)for(let a=i.imeis.length;a<i.cantidad;a++)i.imeis.push(null);else i.cantidad<i.imeis.length&&(i.imeis.length=i.cantidad);else{i.imeis=[];const a=v(i.articulo_id,i);i.cantidad>a&&(i.cantidad=a),i.cantidad<1&&(i.cantidad=1)}}function T(i,e){const a=c.value.find(t=>t.id===i);a&&(e.precio_unitario=Number(a.precioVenta)||0,e.cantidad=1,e.imei=null,Array.isArray(e.imeis)||(e.imeis=[]),y(i)?e.imeis=[null]:e.imeis=[])}async function q(){p.value=await W()}async function M(){c.value=await J(()=>import("./index-CUS9nlnQ.js").then(i=>i.aw),__vite__mapDeps([0,1])).then(i=>i.getTodosArticulos()).then(i=>i||[])}async function C(){f.value=await K()}async function V(){I.value=await X()}async function z(){if(!p.value.some(e=>e.id===o.cliente_id)){n.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const e of o.articulos){const a=c.value.find(t=>t.id===e.articulo_id);if(!a){n.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(!(a.tipo&&a.tipo.toLowerCase()==="servicio")){if(e.cantidad>v(e.articulo_id,e)){n.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(y(e.articulo_id)){if(Array.isArray(e.imeis)){if(e.imeis.length!==e.cantidad||e.imeis.some(r=>!r)){n.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona todos los IMEIs para este artículo.",life:4e3});return}const t=o.articulos.flatMap(r=>Array.isArray(r.imeis)?r.imeis:r.imei?[r.imei]:[]).filter(Boolean);if(new Set(t).size!==t.length){n.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}else if(!e.imei){n.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}}}}try{const e=o.articulos.flatMap(a=>{const t=c.value.find(r=>r.id===a.articulo_id);return t&&t.tipo&&t.tipo.toLowerCase()==="servicio"?[{articulo_id:a.articulo_id,cantidad:a.cantidad,precio_unitario:a.precio_unitario}]:Array.isArray(a.imeis)&&a.imeis.length>0?a.imeis.filter(r=>r).map(r=>({articulo_id:a.articulo_id,cantidad:1,precio_unitario:a.precio_unitario,imei:r})):a.imei?[{articulo_id:a.articulo_id,cantidad:1,precio_unitario:a.precio_unitario,imei:a.imei}]:[{articulo_id:a.articulo_id,cantidad:a.cantidad,precio_unitario:a.precio_unitario}]});await Y({cliente_id:o.cliente_id,fecha:o.fecha,observaciones:o.observaciones,total:D.value,articulos:e}),await Q(),S.value=!0,n.add({severity:"success",summary:"Venta registrada",life:3e3}),o.cliente_id=null,o.observaciones="",o.articulos=[],await C(),await M(),await V()}catch{n.add({severity:"error",summary:"Error",detail:"No se pudo registrar la venta.",life:4e3})}}async function B(i){var e;(e=i==null?void 0:i.data)!=null&&e.id&&(E.value=await Z(i.data.id),b.value=i.data)}G(()=>o.articulos.map(i=>i.imei),(i,e)=>{i.forEach((a,t)=>{a&&a!==e[t]&&console.log("IMEI asignado a payload:",a,"en artículo",o.articulos[t])})});const u=g(()=>p.value.find(i=>i.id===o.cliente_id));function R(){u.value&&(Array.isArray(u.value.usuarios)||(u.value.usuarios=[]),u.value.usuarios.push(""))}function U(){u.value&&(Array.isArray(u.value.plataformas)||(u.value.plataformas=[]),u.value.plataformas.push(""))}return H(()=>{q(),M(),C(),V()}),{today:m,clientes:p,articulosDisponibles:c,ventas:I,ventaSeleccionada:b,detalleVenta:E,imeis:f,showDialog:S,venta:o,totalVenta:D,articulosConStock:L,getStockDisponible:v,imeisDisponiblesPorArticulo:P,mostrarColumnaIMEI:y,addArticulo:N,removeArticulo:x,validateCantidad:O,onArticuloChange:T,guardarVenta:z,cargarDetalleVenta:B,clienteSeleccionado:u,agregarUsuario:R,agregarPlataforma:U}}export{ei as u};
