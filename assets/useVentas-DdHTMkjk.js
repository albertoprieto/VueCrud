const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-cm-GLTEx.js","assets/index-tIwxuEx6.css"])))=>i.map(i=>d[i]);
import{ar as g,as as z,r as u,at as B,l as _,ag as F,k as G,au as H,n as J}from"./index-cm-GLTEx.js";import{g as K}from"./clientesService-BmuydBvf.js";const y="https://64.227.15.111/ventas",Q=async()=>(await g.get(y)).data,W=async r=>(await g.post(y,r)).data,X=async r=>(await g.get(`${y}/${r}/detalle`)).data;function w(){const r=z(),d=new Date().toISOString().slice(0,10),f=u([]),c=u([]),h=u([]),I=u(null),b=u([]),m=u([]),E=u(!1),t=B({cliente_id:null,fecha:d,observaciones:"",articulos:[]}),A=_(()=>t.articulos.reduce((i,a)=>i+a.cantidad*a.precio_unitario,0)),M=_(()=>{const i={};return m.value.forEach(a=>{i[a.articulo_nombre]||(i[a.articulo_nombre]=[]),i[a.articulo_nombre].push(a)}),Object.entries(i).map(([a,e])=>({articulo_nombre:a,cantidad:e.length,imeis:e}))});function v(i,a=null){const e=c.value.find(l=>l.id===i);if(!e)return 0;if(e.tipo&&e.tipo.toLowerCase()==="servicio")return null;const o=M.value.find(l=>l.articulo_nombre===e.nombre),n=o?o.cantidad:0,j=t.articulos.filter(l=>l.articulo_id===i&&(!a||l!==a)).reduce((l,q)=>l+q.cantidad,0);return n-j}function k(i=null){return c.value.filter(a=>{if(a.tipo&&a.tipo.toLowerCase()==="servicio")return!0;const e=v(a.id,i);return i&&i.articulo_id===a.id?!0:e>0})}function C(i,a=null){const e=c.value.find(n=>n.id===i);if(!e)return[];const o=t.articulos.filter(n=>n.articulo_id===i&&n.imei&&n!==a).map(n=>n.imei);return m.value.filter(n=>n.articulo_nombre===e.nombre&&n.status==="Disponible"&&!o.includes(n.imei))}function p(i){const a=c.value.find(e=>e.id===i);return!a||a.tipo&&a.tipo.toLowerCase()==="servicio"?!1:C(i).length>0}function L(){t.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function P(i){t.articulos.splice(i,1)}function N(i){const a=c.value.find(e=>e.id===i.articulo_id);if(a&&a.tipo&&a.tipo.toLowerCase()==="servicio"){i.cantidad<1&&(i.cantidad=1);return}if(p(i.articulo_id))if(Array.isArray(i.imeis)||(i.imeis=[]),i.cantidad>i.imeis.length)for(let e=i.imeis.length;e<i.cantidad;e++)i.imeis.push(null);else i.cantidad<i.imeis.length&&(i.imeis.length=i.cantidad);else{i.imeis=[];const e=v(i.articulo_id,i);i.cantidad>e&&(i.cantidad=e),i.cantidad<1&&(i.cantidad=1)}}function x(i,a){const e=c.value.find(o=>o.id===i);e&&(a.precio_unitario=Number(e.precioVenta)||0,a.cantidad=1,a.imei=null)}async function O(){f.value=await K()}async function S(){c.value=await H(()=>import("./index-cm-GLTEx.js").then(i=>i.av),__vite__mapDeps([0,1])).then(i=>i.getTodosArticulos()).then(i=>i||[])}async function V(){m.value=await J()}async function D(){h.value=await Q()}async function T(){if(!f.value.some(a=>a.id===t.cliente_id)){r.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const a of t.articulos){const e=c.value.find(o=>o.id===a.articulo_id);if(!e){r.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(!(e.tipo&&e.tipo.toLowerCase()==="servicio")){if(a.cantidad>v(a.articulo_id,a)){r.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(p(a.articulo_id)){if(!a.imei){r.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}const o=t.articulos.filter(n=>n.imei).map(n=>n.imei);if(new Set(o).size!==o.length){r.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}}}try{const a=t.articulos.map(e=>{const o=c.value.find(n=>n.id===e.articulo_id);return o&&o.tipo&&o.tipo.toLowerCase()==="servicio"?{articulo_id:e.articulo_id,cantidad:e.cantidad,precio_unitario:e.precio_unitario}:e.imei?{articulo_id:e.articulo_id,cantidad:1,precio_unitario:e.precio_unitario,imei:e.imei}:{articulo_id:e.articulo_id,cantidad:e.cantidad,precio_unitario:e.precio_unitario}});await W({cliente_id:t.cliente_id,fecha:t.fecha,observaciones:t.observaciones,total:A.value,articulos:a}),E.value=!0,r.add({severity:"success",summary:"Venta registrada",life:3e3}),t.cliente_id=null,t.observaciones="",t.articulos=[],await V(),await S(),await D()}catch{r.add({severity:"error",summary:"Error",detail:"No se pudo registrar la venta.",life:4e3})}}async function R(i){var a;(a=i==null?void 0:i.data)!=null&&a.id&&(b.value=await X(i.data.id),I.value=i.data)}F(()=>t.articulos.map(i=>i.imei),(i,a)=>{i.forEach((e,o)=>{e&&e!==a[o]&&console.log("IMEI asignado a payload:",e,"en artículo",t.articulos[o])})});const s=_(()=>f.value.find(i=>i.id===t.cliente_id));function U(){s.value&&(Array.isArray(s.value.usuarios)||(s.value.usuarios=[]),s.value.usuarios.push(""))}function $(){s.value&&(Array.isArray(s.value.plataformas)||(s.value.plataformas=[]),s.value.plataformas.push(""))}return G(()=>{O(),S(),V(),D()}),{today:d,clientes:f,articulosDisponibles:c,ventas:h,ventaSeleccionada:I,detalleVenta:b,imeis:m,showDialog:E,venta:t,totalVenta:A,articulosConStock:k,getStockDisponible:v,imeisDisponiblesPorArticulo:C,mostrarColumnaIMEI:p,addArticulo:L,removeArticulo:P,validateCantidad:N,onArticuloChange:x,guardarVenta:T,cargarDetalleVenta:R,clienteSeleccionado:s,agregarUsuario:U,agregarPlataforma:$}}export{w as u};
