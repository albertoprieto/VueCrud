import{_ as j,r as s,o as E,c as _,a as y,b as n,w as r,u as i,e as b,s as f,t as w,J as G,g as d,f as x,h as D,i as L,j as T,A as M,q,m as z}from"./index-dE5x1ZbV.js";import{_ as J}from"./NotaVentaPDF-xL_UepNi.js";import{g as O,c as K,a as Q,d as W,e as X}from"./ventasService-BxkkrZWJ.js";import{g as Y}from"./clientesService-Di7fQTNN.js";import{g as Z}from"./usuariosService-BqKDeJZl.js";import"./_commonjsHelpers-Cpj98o6Y.js";const P={class:"historico-notas-container"},ee={key:0,class:"chip chip-asignado"},ae={key:1,class:"chip chip-sinasignar"},ie={style:{padding:"1.5rem","text-align":"center"}},ne={__name:"HistoricoNotasVenta",setup(le){const c=s([]),v=s(!0),g=s(!1),A=s(null),C=s(null),V=s([]),F={nombre:"GPSubicacion.com",direccion:"Guadalajara",rfc:"RFC123456"},m=s(!1),h=s(null),N=s([]),u=s(null),o=s(null),p=s(!1),S=s("");E(async()=>{v.value=!0;const t=await O(),a=await Promise.all(t.map(async e=>{const l=await K(e.id);return{...e,cliente_nombre:String(e.cliente_nombre??""),tecnicoNombre:l?String(l.username):"",status:l?"Asignado":"Sin asignar"}}));c.value=a,v.value=!1});async function U(t){v.value=!0,A.value=t;const a=await Q(t.id),e=await Y();C.value=e.find(k=>k.id===t.cliente_id)||{};const l=await z();V.value=a.map(k=>{const $=l.find(H=>H.id===k.articulo_id)||{};return{...k,sku:$.sku,nombre:$.nombre}}),g.value=!0,v.value=!1}async function B(t){h.value=t;const a=await Z();N.value=a.filter(e=>e.perfil==="Tecnico").map(e=>({nombre:e.username,id:e.id,perfil:e.perfil})),u.value=t.tecnicoAsignado??null,o.value=null,m.value=!0}async function I(){if(!h.value||!u.value||!o.value)return;const t=o.value instanceof Date?o.value.toISOString().slice(0,10):typeof o.value=="string"&&o.value.includes("T")?o.value.split("T")[0]:o.value;await W(h.value.id,u.value,t);const a=N.value.find(l=>l.id===u.value),e=c.value.findIndex(l=>l.id===h.value.id);if(e!==-1&&a){const l=[...c.value];l[e]={...l[e],tecnicoAsignado:a.id,tecnicoNombre:a.nombre,status:"Asignado"},c.value=l}m.value=!1,S.value="Técnico asignado",p.value=!0}async function R(t){if(!t.id)return;await X(t.id);const a=c.value.findIndex(e=>e.id===t.id);if(a!==-1){const e=[...c.value];e[a]={...e[a],tecnicoAsignado:null,tecnicoNombre:null,status:"Sin asignar"},c.value=e}S.value="Asignación eliminada",p.value=!0}return(t,a)=>(b(),_("div",P,[a[8]||(a[8]=y("h2",{class:"historico-title"},"Histórico de Notas de Venta",-1)),n(i(L),{value:c.value,loading:v.value,responsiveLayout:"scroll",class:"historico-table"},{default:r(()=>[n(i(f),{field:"id",header:"Folio"}),n(i(f),{field:"cliente_nombre",header:"Cliente"}),n(i(f),{field:"tecnicoNombre",header:"Asignado a"},{body:r(e=>[e.data.tecnicoNombre?(b(),_("span",ee,w(e.data.tecnicoNombre),1)):(b(),_("span",ae,"Sin asignar"))]),_:1}),n(i(f),{field:"status",header:"Status"},{body:r(e=>[y("span",{class:G(["chip",{"chip-asignado":e.data.tecnicoNombre,"chip-sinasignar":!e.data.tecnicoNombre}])},w(e.data.tecnicoNombre?"Asignado":"Sin asignar"),3)]),_:1}),n(i(f),{header:"Acciones"},{body:r(e=>[n(i(d),{icon:"pi pi-file-pdf",label:"PDF",class:"p-button-sm p-button-success",onClick:l=>U(e.data)},null,8,["onClick"]),n(i(d),{icon:e.data.tecnicoNombre?"pi pi-user-edit":"pi pi-user-plus",label:e.data.tecnicoNombre?"Cambiar técnico":"Asignar técnico",class:"p-button-sm p-button-info ml-2",onClick:l=>B(e.data)},null,8,["icon","label","onClick"]),e.data.tecnicoNombre?(b(),x(i(d),{key:0,icon:"pi pi-trash",label:"Eliminar asignación",class:"p-button-sm p-button-danger ml-2",onClick:l=>R(e.data)},null,8,["onClick"])):D("",!0)]),_:1})]),_:1},8,["value","loading"]),n(i(T),{visible:g.value,"onUpdate:visible":a[1]||(a[1]=e=>g.value=e),header:"Nota de Venta",modal:!0,class:"historico-dialog"},{default:r(()=>[A.value&&C.value&&V.value.length?(b(),x(J,{key:0,venta:A.value,cliente:C.value,articulos:V.value,empresa:F,"venta-registrada":!0},null,8,["venta","cliente","articulos"])):D("",!0),n(i(d),{label:"Cerrar",icon:"pi pi-times",onClick:a[0]||(a[0]=e=>g.value=!1),class:"mt-3"})]),_:1},8,["visible"]),n(i(T),{visible:m.value,"onUpdate:visible":a[5]||(a[5]=e=>m.value=e),header:"Asignar Técnico",modal:!0},{default:r(()=>[n(i(M),{modelValue:u.value,"onUpdate:modelValue":a[2]||(a[2]=e=>u.value=e),options:N.value,optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona técnico",class:"w-full mb-3"},null,8,["modelValue","options"]),n(i(q),{modelValue:o.value,"onUpdate:modelValue":a[3]||(a[3]=e=>o.value=e),dateFormat:"yy-mm-dd",placeholder:"Selecciona fecha de servicio",class:"w-full mb-3"},null,8,["modelValue"]),n(i(d),{label:"Asignar",icon:"pi pi-check",onClick:I,disabled:!u.value||!o.value},null,8,["disabled"]),n(i(d),{label:"Cancelar",icon:"pi pi-times",onClick:a[4]||(a[4]=e=>m.value=!1),class:"p-button-secondary ml-2"})]),_:1},8,["visible"]),n(i(T),{visible:p.value,"onUpdate:visible":a[7]||(a[7]=e=>p.value=e),header:"Resultado",modal:!0},{default:r(()=>[y("div",ie,[y("span",null,w(S.value),1)]),n(i(d),{label:"Aceptar",icon:"pi pi-check",onClick:a[6]||(a[6]=e=>p.value=!1),class:"mt-3"})]),_:1},8,["visible"])]))}},de=j(ne,[["__scopeId","data-v-38b04877"]]);export{de as default};
