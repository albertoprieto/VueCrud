import{B as G,C as P,r as y,D as ee,l as H,E as ae,k as te,m as ie,_ as le,c as D,a as s,b as d,d as e,w as v,t as C,G as J,o as M,p as O,g as K,s as m,n as Q,q as $,i as U,H as ne,e as W,I as oe,j as de}from"./index-CLV_fX0D.js";import{g as se}from"./clientesService-C1HhsYGB.js";const z="https://64.227.15.111/ventas",ce=async()=>(await G.get(z)).data,re=async u=>(await G.post(z,u)).data,ue=async u=>(await G.get(`${z}/${u}/detalle`)).data;function me(){const u=P(),h=new Date().toISOString().slice(0,10),S=y([]),b=y([]),w=y([]),I=y(null),N=y([]),E=y([]),g=y(!1),o=ee({cliente_id:null,fecha:h,observaciones:"",articulos:[]}),x=H(()=>o.articulos.reduce((i,t)=>i+t.cantidad*t.precio_unitario,0)),A=H(()=>{const i={};return E.value.forEach(t=>{i[t.articulo_nombre]||(i[t.articulo_nombre]=[]),i[t.articulo_nombre].push(t)}),Object.entries(i).map(([t,n])=>({articulo_nombre:t,cantidad:n.length,imeis:n}))});function p(i,t=null){const n=b.value.find(_=>_.id===i);if(!n)return 0;const c=A.value.find(_=>_.articulo_nombre===n.nombre),r=c?c.cantidad:0,Y=o.articulos.filter(_=>_.articulo_id===i&&(!t||_!==t)).reduce((_,Z)=>_+Z.cantidad,0);return r-Y}function L(i=null){return b.value.filter(t=>{const n=p(t.id,i);return i&&i.articulo_id===t.id?!0:n>0})}function V(i,t=null){const n=b.value.find(r=>r.id===i);if(!n)return[];const c=o.articulos.filter(r=>r.articulo_id===i&&r.imei&&r!==t).map(r=>r.imei);return E.value.filter(r=>r.articulo_nombre===n.nombre&&r.status==="Disponible"&&!c.includes(r.imei))}function k(i){return V(i).length>0}function R(){o.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function B(i){o.articulos.splice(i,1)}function F(i){if(k(i.articulo_id))i.cantidad=1;else{const t=p(i.articulo_id,i);i.cantidad>t&&(i.cantidad=t),i.cantidad<1&&(i.cantidad=1)}}function q(i,t){const n=b.value.find(c=>c.id===i);n&&(t.precio_unitario=Number(n.precioVenta)||0,t.cantidad=(k(i),1),t.imei=null)}async function T(){S.value=await se()}async function j(){const i=await fetch("https://64.227.15.111/articulos/todos");b.value=await i.json()}async function l(){E.value=await ie()}async function a(){w.value=await ce()}async function f(){if(!S.value.some(t=>t.id===o.cliente_id)){u.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const t of o.articulos){if(!b.value.find(c=>c.id===t.articulo_id)){u.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(t.cantidad>p(t.articulo_id,t)){u.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(k(t.articulo_id)){if(!t.imei){u.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}const c=o.articulos.filter(r=>r.imei).map(r=>r.imei);if(new Set(c).size!==c.length){u.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}}try{const t=o.articulos.map(n=>n.imei?{articulo_id:n.articulo_id,cantidad:1,precio_unitario:n.precio_unitario,imei:n.imei}:{articulo_id:n.articulo_id,cantidad:n.cantidad,precio_unitario:n.precio_unitario});console.log("Payload articulos:",t),await re({cliente_id:o.cliente_id,fecha:o.fecha,observaciones:o.observaciones,total:x.value,articulos:t}),g.value=!0,u.add({severity:"success",summary:"Venta registrada",life:3e3}),o.cliente_id=null,o.observaciones="",o.articulos=[],await l(),await j(),await a()}catch(t){u.add({severity:"error",summary:"Error al guardar",detail:t.message,life:4e3})}}async function X(i){var n,c;const t=((n=i.data)==null?void 0:n.id)||((c=I.value)==null?void 0:c.id);t&&(N.value=await ue(t))}return ae(()=>o.articulos.map(i=>i.imei),(i,t)=>{i.forEach((n,c)=>{n&&n!==t[c]&&console.log("IMEI asignado a payload:",n,"en artículo",o.articulos[c])})}),te(()=>{T(),j(),l(),a()}),{today:h,clientes:S,articulosDisponibles:b,ventas:w,ventaSeleccionada:I,detalleVenta:N,imeis:E,showDialog:g,venta:o,totalVenta:x,articulosConStock:L,getStockDisponible:p,imeisDisponiblesPorArticulo:V,mostrarColumnaIMEI:k,addArticulo:R,removeArticulo:B,validateCantidad:F,onArticuloChange:q,guardarVenta:f,cargarDetalleVenta:X}}const fe={class:"ventas-container"},ve={class:"ventas-card"},pe={class:"ventas-form-header"},be={class:"ventas-form-col"},_e={class:"ventas-form-col"},ge={key:0,class:"error-text"},Ve={key:1,class:"info-text"},ye={class:"imei-cell"},he={key:1,class:"imei-seleccionado"},Ie={class:"imei-value"},ke={class:"mb-2"},Ce={class:"mb-2"},Se={__name:"Ventas",setup(u){const{today:h,clientes:S,articulosDisponibles:b,ventas:w,ventaSeleccionada:I,detalleVenta:N,imeis:E,showDialog:g,venta:o,totalVenta:x,articulosConStock:A,getStockDisponible:p,imeisDisponiblesPorArticulo:L,mostrarColumnaIMEI:V,addArticulo:k,removeArticulo:R,validateCantidad:B,onArticuloChange:F,guardarVenta:q,cargarDetalleVenta:T}=me();return(j,l)=>(M(),D("div",fe,[l[13]||(l[13]=s("h2",{class:"ventas-title"},"Registrar Nota de Venta",-1)),s("div",ve,[s("div",pe,[s("div",be,[l[6]||(l[6]=s("label",{class:"mb-2"},"Cliente",-1)),d(e(O),{modelValue:e(o).cliente_id,"onUpdate:modelValue":l[0]||(l[0]=a=>e(o).cliente_id=a),options:e(S),optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona un cliente",class:"w-full"},null,8,["modelValue","options"])]),s("div",_e,[l[7]||(l[7]=s("label",null,"Fecha",-1)),d(e(K),{modelValue:e(o).fecha,"onUpdate:modelValue":l[1]||(l[1]=a=>e(o).fecha=a),value:e(h),readonly:"",class:"fecha-input"},null,8,["modelValue","value"])])]),l[11]||(l[11]=s("h3",null,"Artículos",-1)),d(e(W),{value:e(o).articulos,responsiveLayout:"scroll",class:"venta-articulos-table"},{default:v(()=>[d(e(m),{header:"Artículo"},{body:v(a=>[d(e(O),{modelValue:a.data.articulo_id,"onUpdate:modelValue":f=>a.data.articulo_id=f,options:e(A)(a.data),optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona artículo",class:"w-full",onChange:f=>e(F)(a.data.articulo_id,a.data),disabled:e(A)(a.data).length===0},null,8,["modelValue","onUpdate:modelValue","options","onChange","disabled"])]),_:1}),d(e(m),{header:"Stock"},{body:v(a=>[Q(C(e(p)(a.data.articulo_id,a.data)),1)]),_:1}),d(e(m),{field:"cantidad",header:"Cantidad"},{body:v(a=>[d(e(K),{type:"number",modelValue:a.data.cantidad,"onUpdate:modelValue":f=>a.data.cantidad=f,modelModifiers:{number:!0},min:1,max:e(V)(a.data.articulo_id)?1:e(p)(a.data.articulo_id,a.data),class:"w-full",disabled:!a.data.articulo_id||e(V)(a.data.articulo_id),onInput:f=>e(B)(a.data)},null,8,["modelValue","onUpdate:modelValue","max","disabled","onInput"]),a.data.cantidad>e(p)(a.data.articulo_id,a.data)?(M(),D("small",ge," Máx: "+C(e(p)(a.data.articulo_id,a.data)),1)):$("",!0),e(V)(a.data.articulo_id)?(M(),D("small",Ve," Solo puedes vender un equipo por fila si requiere IMEI. ")):$("",!0)]),_:1}),d(e(m),{field:"precio_unitario",header:"Precio"},{body:v(a=>[s("span",null,C(a.data.precio_unitario.toFixed(2)),1)]),_:1}),d(e(m),{field:"subtotal",header:"Subtotal"},{body:v(a=>[Q(C((a.data.cantidad*a.data.precio_unitario).toFixed(2)),1)]),_:1}),d(e(m),{header:"Acciones"},{body:v(a=>[d(e(U),{icon:"pi pi-trash",class:"p-button-danger p-button-sm",onClick:f=>e(R)(a.index)},null,8,["onClick"])]),_:1}),d(e(m),{header:"IMEI"},{body:v(a=>[s("div",ye,[e(V)(a.data.articulo_id)?(M(),ne(e(O),{key:0,modelValue:a.data.imei,"onUpdate:modelValue":f=>a.data.imei=f,options:e(L)(a.data.articulo_id,a.data),optionLabel:"imei",optionValue:"imei",placeholder:"Selecciona IMEI",class:"w-full imei-dropdown",disabled:!a.data.articulo_id},null,8,["modelValue","onUpdate:modelValue","options","disabled"])):$("",!0),a.data.imei?(M(),D("div",he,[l[8]||(l[8]=s("span",null,"IMEI seleccionado:",-1)),s("span",Ie,C(a.data.imei),1)])):$("",!0)])]),_:1})]),_:1},8,["value"]),d(e(U),{label:"Agregar Artículo",icon:"pi pi-plus",class:"mb-2",onClick:e(k),disabled:e(A)().length===0},null,8,["onClick","disabled"]),s("div",ke,[l[9]||(l[9]=s("label",null,"Observaciones",-1)),d(e(oe),{modelValue:e(o).observaciones,"onUpdate:modelValue":l[2]||(l[2]=a=>e(o).observaciones=a),rows:"2"},null,8,["modelValue"])]),s("div",Ce,[s("strong",null,"Total: $"+C(e(x).toFixed(2)),1)]),d(e(U),{label:"Guardar Venta",class:"mb-2",onClick:e(q),disabled:!e(o).cliente_id||e(o).articulos.length===0},null,8,["onClick","disabled"]),l[12]||(l[12]=s("h2",{class:"ventas-title"},"Ventas Registradas",-1)),d(e(W),{value:e(w),selectionMode:"single",selection:e(I),"onUpdate:selection":l[3]||(l[3]=a=>J(I)?I.value=a:null),onRowSelect:e(T)},{default:v(()=>[d(e(m),{field:"id",header:"ID"}),d(e(m),{field:"cliente_nombre",header:"Cliente"}),d(e(m),{field:"fecha",header:"Fecha"}),d(e(m),{field:"total",header:"Total"})]),_:1},8,["value","selection","onRowSelect"]),d(e(de),{visible:e(g),"onUpdate:visible":l[5]||(l[5]=a=>J(g)?g.value=a:null),header:"Venta registrada",closable:!1,modal:!0,class:"ventas-dialog"},{default:v(()=>[l[10]||(l[10]=s("p",null,"La nota de venta se registró correctamente.",-1)),d(e(U),{label:"Aceptar",icon:"pi pi-check",onClick:l[4]||(l[4]=a=>g.value=!1),autofocus:""})]),_:1},8,["visible"])])]))}},Me=le(Se,[["__scopeId","data-v-5d27f73c"]]);export{Me as default};
