import{B as p,J as z,r as l,K as B,l as k,I as J,k as K,m as L}from"./index-D76T6ImS.js";import{g as R}from"./clientesService-DY7DchyK.js";const g="https://64.227.15.111/ventas",T=async()=>(await p.get(g)).data,U=async c=>(await p.post(g,c)).data,F=async c=>(await p.get(`${g}/${c}/detalle`)).data;function Q(){const c=z(),u=new Date().toISOString().slice(0,10),v=l([]),s=l([]),y=l([]),_=l(null),I=l([]),d=l([]),h=l(!1),a=B({cliente_id:null,fecha:u,observaciones:"",articulos:[]}),b=k(()=>a.articulos.reduce((i,t)=>i+t.cantidad*t.precio_unitario,0)),D=k(()=>{const i={};return d.value.forEach(t=>{i[t.articulo_nombre]||(i[t.articulo_nombre]=[]),i[t.articulo_nombre].push(t)}),Object.entries(i).map(([t,e])=>({articulo_nombre:t,cantidad:e.length,imeis:e}))});function f(i,t=null){const e=s.value.find(r=>r.id===i);if(!e)return 0;const n=D.value.find(r=>r.articulo_nombre===e.nombre),o=n?n.cantidad:0,$=a.articulos.filter(r=>r.articulo_id===i&&(!t||r!==t)).reduce((r,q)=>r+q.cantidad,0);return o-$}function A(i=null){return s.value.filter(t=>{const e=f(t.id,i);return i&&i.articulo_id===t.id?!0:e>0})}function E(i,t=null){const e=s.value.find(o=>o.id===i);if(!e)return[];const n=a.articulos.filter(o=>o.articulo_id===i&&o.imei&&o!==t).map(o=>o.imei);return d.value.filter(o=>o.articulo_nombre===e.nombre&&o.status==="Disponible"&&!n.includes(o.imei))}function m(i){return E(i).length>0}function C(){a.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function w(i){a.articulos.splice(i,1)}function P(i){if(m(i.articulo_id))i.cantidad=1;else{const t=f(i.articulo_id,i);i.cantidad>t&&(i.cantidad=t),i.cantidad<1&&(i.cantidad=1)}}function x(i,t){const e=s.value.find(n=>n.id===i);e&&(t.precio_unitario=Number(e.precioVenta)||0,t.cantidad=(m(i),1),t.imei=null)}async function N(){v.value=await R()}async function S(){const i=await fetch("https://64.227.15.111/articulos/todos");s.value=await i.json()}async function V(){d.value=await L()}async function M(){y.value=await T()}async function j(){if(!v.value.some(t=>t.id===a.cliente_id)){c.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const t of a.articulos){if(!s.value.find(n=>n.id===t.articulo_id)){c.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(t.cantidad>f(t.articulo_id,t)){c.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(m(t.articulo_id)){if(!t.imei){c.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}const n=a.articulos.filter(o=>o.imei).map(o=>o.imei);if(new Set(n).size!==n.length){c.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}}try{const t=a.articulos.map(e=>e.imei?{articulo_id:e.articulo_id,cantidad:1,precio_unitario:e.precio_unitario,imei:e.imei}:{articulo_id:e.articulo_id,cantidad:e.cantidad,precio_unitario:e.precio_unitario});console.log("Payload articulos:",t),await U({cliente_id:a.cliente_id,fecha:a.fecha,observaciones:a.observaciones,total:b.value,articulos:t}),h.value=!0,c.add({severity:"success",summary:"Venta registrada",life:3e3}),a.cliente_id=null,a.observaciones="",a.articulos=[],await V(),await S(),await M()}catch(t){c.add({severity:"error",summary:"Error al guardar",detail:t.message,life:4e3})}}async function O(i){var e,n;const t=((e=i.data)==null?void 0:e.id)||((n=_.value)==null?void 0:n.id);t&&(I.value=await F(t))}return J(()=>a.articulos.map(i=>i.imei),(i,t)=>{i.forEach((e,n)=>{e&&e!==t[n]&&console.log("IMEI asignado a payload:",e,"en artículo",a.articulos[n])})}),K(()=>{N(),S(),V(),M()}),{today:u,clientes:v,articulosDisponibles:s,ventas:y,ventaSeleccionada:_,detalleVenta:I,imeis:d,showDialog:h,venta:a,totalVenta:b,articulosConStock:A,getStockDisponible:f,imeisDisponiblesPorArticulo:E,mostrarColumnaIMEI:m,addArticulo:C,removeArticulo:w,validateCantidad:P,onArticuloChange:x,guardarVenta:j,cargarDetalleVenta:O}}export{Q as u};
