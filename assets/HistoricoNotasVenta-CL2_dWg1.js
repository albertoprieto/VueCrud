import{_ as Z,r as t,o as P,z as B,c as L,a as N,b as n,u as i,w as p,a9 as ee,e as h,C as O,g as d,s as A,t as E,K as ae,i as H,j as M,h as le,k as R,y as oe,A as ne}from"./index-D4-v7Pbq.js";import{_ as ie}from"./NotaVentaPDF-CD0-1mlX.js";import{a as te,c as se,g as ce,d as ue,e as re}from"./ventasService-BIbRGUZH.js";import{g as de}from"./clientesService-CEpfwRfx.js";import{g as ve}from"./usuariosService-DXw0tvi6.js";import"./_commonjsHelpers-Cpj98o6Y.js";const me={class:"historico-notas-container"},pe={class:"filtros",style:{display:"flex",gap:"1rem","margin-bottom":"1.5rem"}},fe={key:0,class:"chip chip-asignado"},be={key:1,class:"chip chip-sinasignar"},ge={style:{padding:"1.5rem","text-align":"center"}},Ve={__name:"HistoricoNotasVenta",setup(we){const c=t([]),g=t(!0),S=t(!1),U=t(null),_=t(null),x=t([]),j={nombre:"GPSubicacion.com",direccion:"Guadalajara",rfc:"RFC123456"},V=t(!1),T=t(null),$=t([]),v=t(null),s=t(null),w=t(!1),D=t(""),C=t(""),k=t(""),u=t(""),F=t(""),m=t([]),f=t("");P(async()=>{g.value=!0;const l=await te(),e=await Promise.all(l.map(async o=>{const a=await se(o.id);return{...o,cliente_nombre:String(o.cliente_nombre??""),tecnicoNombre:a?String(a.username):"",status:a?"Asignado":"Sin asignar"}}));c.value=e,g.value=!1});const z=B(()=>{const l=new Set;return c.value.forEach(e=>e.cliente_nombre&&l.add(e.cliente_nombre)),Array.from(l)}),G=B(()=>{const l=new Set;return c.value.forEach(e=>e.tecnicoNombre&&l.add(e.tecnicoNombre)),Array.from(l)}),K=B(()=>c.value.filter(l=>{const e=!C.value||String(l.id).toLowerCase().includes(C.value.toLowerCase()),o=!k.value||l.cliente_nombre===k.value,a=!u.value||l.tecnicoNombre===u.value;typeof u.value=="string"?l.tecnicoNombre&&l.tecnicoNombre.toLowerCase().includes(u.value.toLowerCase()):l.tecnicoNombre&&(l.tecnicoNombre,u.value.nombre);const r=!F.value||l.status===F.value;let y=!0;if(m.value&&m.value.length===2&&m.value[0]&&m.value[1]){const b=new Date(l.fecha),X=new Date(m.value[0]),Y=new Date(m.value[1]);y=b>=X&&b<=Y}const I=!f.value||l.detalle&&l.detalle.some(b=>b.imei&&(b.imei.includes(f.value)||b.imei.slice(-5)===f.value));return e&&o&&a&&r&&y&&I}));async function q(l){g.value=!0,U.value=l;const e=await ce(l.id),o=await de();_.value=o.find(r=>r.id===l.cliente_id)||{};const a=await ne();x.value=e.map(r=>{const y=a.find(I=>I.id===r.articulo_id)||{};return{...r,sku:y.sku,nombre:y.nombre}}),S.value=!0,g.value=!1}async function J(l){T.value=l;const e=await ve();$.value=e.filter(o=>o.perfil==="Tecnico").map(o=>({nombre:o.username,id:o.id,perfil:o.perfil})),v.value=l.tecnicoAsignado??null,s.value=null,V.value=!0}async function Q(){if(!T.value||!v.value||!s.value)return;const l=s.value instanceof Date?s.value.toISOString().slice(0,10):typeof s.value=="string"&&s.value.includes("T")?s.value.split("T")[0]:s.value;await ue(T.value.id,v.value,l);const e=$.value.find(a=>a.id===v.value),o=c.value.findIndex(a=>a.id===T.value.id);if(o!==-1&&e){const a=[...c.value];a[o]={...a[o],tecnicoAsignado:e.id,tecnicoNombre:e.nombre,status:"Asignado"},c.value=a}V.value=!1,D.value="Técnico asignado",w.value=!0}async function W(l){if(!l.id)return;await re(l.id);const e=c.value.findIndex(o=>o.id===l.id);if(e!==-1){const o=[...c.value];o[e]={...o[e],tecnicoAsignado:null,tecnicoNombre:null,status:"Sin asignar"},c.value=o}D.value="Asignación eliminada",w.value=!0}return(l,e)=>{const o=ee("InputText");return h(),L("div",me,[e[14]||(e[14]=N("h2",{class:"historico-title"},"Histórico de Notas de Venta",-1)),N("div",pe,[n(o,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=a=>C.value=a),placeholder:"Buscar por folio...",class:"filtro-input",clearable:""},null,8,["modelValue"]),n(i(O),{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=a=>k.value=a),options:z.value,placeholder:"Filtrar por cliente",class:"filtro-dropdown",showClear:"",filter:""},null,8,["modelValue","options"]),n(o,{modelValue:u.value,"onUpdate:modelValue":e[2]||(e[2]=a=>u.value=a),placeholder:"Buscar por técnico...",class:"filtro-input",clearable:""},null,8,["modelValue"]),n(i(O),{modelValue:u.value,"onUpdate:modelValue":e[3]||(e[3]=a=>u.value=a),options:G.value,placeholder:"Filtrar por asignado a",class:"filtro-dropdown",showClear:"",filter:""},null,8,["modelValue","options"]),n(o,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=a=>f.value=a),placeholder:"Buscar por IMEI...",class:"filtro-input",clearable:""},null,8,["modelValue"]),n(i(d),{label:"Limpiar",icon:"pi pi-times",class:"p-button-secondary",onClick:e[5]||(e[5]=()=>{C.value="",k.value="",u.value="",F.value="",m.value=[],f.value=""})})]),n(i(le),{value:K.value,loading:g.value,responsiveLayout:"scroll",class:"historico-table"},{default:p(()=>[n(i(A),{field:"id",header:"Folio"}),n(i(A),{field:"cliente_nombre",header:"Cliente"}),n(i(A),{field:"tecnicoNombre",header:"Asignado a"},{body:p(a=>[a.data.tecnicoNombre?(h(),L("span",fe,E(a.data.tecnicoNombre),1)):(h(),L("span",be,"Sin asignar"))]),_:1}),n(i(A),{field:"status",header:"Status"},{body:p(a=>[N("span",{class:ae(["chip",{"chip-asignado":a.data.tecnicoNombre,"chip-sinasignar":!a.data.tecnicoNombre}])},E(a.data.tecnicoNombre?"Asignado":"Sin asignar"),3)]),_:1}),n(i(A),{header:"Acciones"},{body:p(a=>[n(i(d),{icon:"pi pi-file-pdf",label:"PDF",class:"p-button-sm p-button-success",onClick:r=>q(a.data)},null,8,["onClick"]),n(i(d),{icon:a.data.tecnicoNombre?"pi pi-user-edit":"pi pi-user-plus",label:a.data.tecnicoNombre?"Cambiar técnico":"Asignar técnico",class:"p-button-sm p-button-info ml-2",onClick:r=>J(a.data)},null,8,["icon","label","onClick"]),a.data.tecnicoNombre?(h(),H(i(d),{key:0,icon:"pi pi-trash",label:"Eliminar asignación",class:"p-button-sm p-button-danger ml-2",onClick:r=>W(a.data)},null,8,["onClick"])):M("",!0)]),_:1})]),_:1},8,["value","loading"]),n(i(R),{visible:S.value,"onUpdate:visible":e[7]||(e[7]=a=>S.value=a),header:"Nota de Venta",modal:!0,class:"historico-dialog"},{default:p(()=>[U.value&&_.value&&x.value.length?(h(),H(ie,{key:0,venta:U.value,cliente:_.value,articulos:x.value,empresa:j,"venta-registrada":!0},null,8,["venta","cliente","articulos"])):M("",!0),n(i(d),{label:"Cerrar",icon:"pi pi-times",onClick:e[6]||(e[6]=a=>S.value=!1),class:"mt-3"})]),_:1},8,["visible"]),n(i(R),{visible:V.value,"onUpdate:visible":e[11]||(e[11]=a=>V.value=a),header:"Asignar Técnico",modal:!0},{default:p(()=>[n(i(O),{modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=a=>v.value=a),options:$.value,optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona técnico",class:"w-full mb-3"},null,8,["modelValue","options"]),n(i(oe),{modelValue:s.value,"onUpdate:modelValue":e[9]||(e[9]=a=>s.value=a),dateFormat:"yy-mm-dd",placeholder:"Selecciona fecha de servicio",class:"w-full mb-3"},null,8,["modelValue"]),n(i(d),{label:"Asignar",icon:"pi pi-check",onClick:Q,disabled:!v.value||!s.value},null,8,["disabled"]),n(i(d),{label:"Cancelar",icon:"pi pi-times",onClick:e[10]||(e[10]=a=>V.value=!1),class:"p-button-secondary ml-2"})]),_:1},8,["visible"]),n(i(R),{visible:w.value,"onUpdate:visible":e[13]||(e[13]=a=>w.value=a),header:"Resultado",modal:!0},{default:p(()=>[N("div",ge,[N("span",null,E(D.value),1)]),n(i(d),{label:"Aceptar",icon:"pi pi-check",onClick:e[12]||(e[12]=a=>w.value=!1),class:"mt-3"})]),_:1},8,["visible"])])}}},Se=Z(Ve,[["__scopeId","data-v-4d455f43"]]);export{Se as default};
