const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B_EOEPfX.js","assets/index-DuG-mBS3.css"])))=>i.map(i=>d[i]);
import{ar as R,r as d,as as U,l as y,ag as G,o as H,at as J,n as K,au as Q}from"./index-B_EOEPfX.js";import{g as W}from"./clientesService-D_QOJkoT.js";import{a as C,b as X,g as Y}from"./ventasService-ClIJRqci.js";function ii(){const u=R(),g=new Date().toISOString().slice(0,10),m=d([]),s=d([]),A=d([]),h=d(null),b=d([]),f=d([]),I=d(!1),o=U({cliente_id:null,fecha:g,observaciones:"",articulos:[]}),E=y(()=>o.articulos.reduce((i,e)=>i+e.cantidad*e.precio_unitario,0)),V=y(()=>{const i={};return f.value.filter(e=>e.status==="Disponible"||e.status==="Devuelto").forEach(e=>{i[e.articulo_nombre]||(i[e.articulo_nombre]=[]),i[e.articulo_nombre].push(e)}),Object.entries(i).map(([e,a])=>({articulo_nombre:e,cantidad:a.length,imeis:a}))});function p(i,e=null){const a=s.value.find(l=>l.id===i);if(!a)return 0;if(a.tipo&&a.tipo.toLowerCase()==="servicio")return null;const t=V.value.find(l=>l.articulo_nombre===a.nombre),r=t?t.cantidad:0,_=o.articulos.filter(l=>l.articulo_id===i&&(!e||l!==e)).reduce((l,n)=>l+n.cantidad,0);return r-_}function k(i=null){return s.value.filter(e=>{if(e.tipo&&e.tipo.toLowerCase()==="servicio")return!0;const a=p(e.id,i);return i&&i.articulo_id===e.id?!0:a>0})}function L(i,e=null,a=null){const t=s.value.find(n=>n.id===i);if(!t)return[];let r=[];e&&Array.isArray(e.imeis)&&(r=e.imeis.filter((n,F)=>n&&F!==a));const _=o.articulos.filter(n=>n.articulo_id===i&&n!==e&&Array.isArray(n.imeis)).flatMap(n=>n.imeis.filter(Boolean)),l=[...r,..._];return f.value.filter(n=>n.articulo_nombre===t.nombre&&(n.status==="Disponible"||n.status==="Devuelto")&&!l.includes(n.imei))}function v(i,e=null,a=null){const t=s.value.find(r=>r.id===i);return!t||t.tipo&&t.tipo.toLowerCase()==="servicio"?!1:f.value.some(r=>r.articulo_nombre===t.nombre&&(r.status==="Disponible"||r.status==="Devuelto"))}function N(){o.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function P(i){o.articulos.splice(i,1)}function O(i){const e=s.value.find(a=>a.id===i.articulo_id);if(e&&e.tipo&&e.tipo.toLowerCase()==="servicio"){i.cantidad<1&&(i.cantidad=1);return}if(v(i.articulo_id))if(Array.isArray(i.imeis)||(i.imeis=[]),i.cantidad>i.imeis.length)for(let a=i.imeis.length;a<i.cantidad;a++)i.imeis.push(null);else i.cantidad<i.imeis.length&&(i.imeis.length=i.cantidad);else{i.imeis=[];const a=p(i.articulo_id,i);i.cantidad>a&&(i.cantidad=a),i.cantidad<1&&(i.cantidad=1)}}function x(i,e){const a=s.value.find(t=>t.id===i);a&&(e.precio_unitario=Number(a.precioVenta)||0,e.cantidad=1,e.imei=null,Array.isArray(e.imeis)||(e.imeis=[]),v(i)?e.imeis=[null]:e.imeis=[])}async function z(){m.value=await W()}async function S(){s.value=await J(()=>import("./index-B_EOEPfX.js").then(i=>i.az),__vite__mapDeps([0,1])).then(i=>i.getTodosArticulos()).then(i=>i||[])}async function D(){f.value=await K()}async function M(){A.value=await C()}async function T(){if(!m.value.some(e=>e.id===o.cliente_id)){u.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const e of o.articulos){const a=s.value.find(t=>t.id===e.articulo_id);if(!a){u.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(!(a.tipo&&a.tipo.toLowerCase()==="servicio")){if(e.cantidad>p(e.articulo_id,e)){u.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(v(e.articulo_id)){if(Array.isArray(e.imeis)){if(e.imeis.length!==e.cantidad||e.imeis.some(r=>!r)){u.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona todos los IMEIs para este artículo.",life:4e3});return}const t=o.articulos.flatMap(r=>Array.isArray(r.imeis)?r.imeis:r.imei?[r.imei]:[]).filter(Boolean);if(new Set(t).size!==t.length){u.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}else if(!e.imei){u.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}}}}try{const e=o.articulos.flatMap(a=>{const t=s.value.find(r=>r.id===a.articulo_id);return t&&t.tipo&&t.tipo.toLowerCase()==="servicio"?[{articulo_id:a.articulo_id,cantidad:a.cantidad,precio_unitario:a.precio_unitario}]:Array.isArray(a.imeis)&&a.imeis.length>0?a.imeis.filter(r=>r).map(r=>({articulo_id:a.articulo_id,cantidad:1,precio_unitario:a.precio_unitario,imei:r})):a.imei?[{articulo_id:a.articulo_id,cantidad:1,precio_unitario:a.precio_unitario,imei:a.imei}]:[{articulo_id:a.articulo_id,cantidad:a.cantidad,precio_unitario:a.precio_unitario}]});await X({cliente_id:o.cliente_id,fecha:o.fecha,observaciones:o.observaciones,total:E.value,articulos:e}),await Q(),I.value=!0,u.add({severity:"success",summary:"Venta registrada",life:3e3}),o.cliente_id=null,o.observaciones="",o.articulos=[],await D(),await S(),await M()}catch{u.add({severity:"error",summary:"Error",detail:"No se pudo registrar la venta.",life:4e3})}}async function q(i){var e;(e=i==null?void 0:i.data)!=null&&e.id&&(b.value=await Y(i.data.id),h.value=i.data)}G(()=>o.articulos.map(i=>i.imei),(i,e)=>{i.forEach((a,t)=>{a&&a!==e[t]&&console.log("IMEI asignado a payload:",a,"en artículo",o.articulos[t])})});const c=y(()=>m.value.find(i=>i.id===o.cliente_id));function B(){c.value&&(Array.isArray(c.value.usuarios)||(c.value.usuarios=[]),c.value.usuarios.push(""))}function j(){c.value&&(Array.isArray(c.value.plataformas)||(c.value.plataformas=[]),c.value.plataformas.push(""))}return H(()=>{z(),S(),D(),M()}),{today:g,clientes:m,articulosDisponibles:s,ventas:A,ventaSeleccionada:h,detalleVenta:b,imeis:f,showDialog:I,venta:o,totalVenta:E,articulosConStock:k,getStockDisponible:p,imeisDisponiblesPorArticulo:L,mostrarColumnaIMEI:v,addArticulo:N,removeArticulo:P,validateCantidad:O,onArticuloChange:x,guardarVenta:T,cargarDetalleVenta:q,clienteSeleccionado:c,agregarUsuario:B,agregarPlataforma:j,getVentas:C}}export{ii as u};
