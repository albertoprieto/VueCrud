import{B as $,_ as P,C as ee,r as p,D as ae,l as R,k as te,c as y,a as d,b as l,d as i,w as u,t as _,q as h,m as ie,o as V,p as A,g as T,s as r,n as O,i as C,E as le,e as w,G as ne,j as oe}from"./index-ZZDPN2c_.js";import{g as de}from"./clientesService-ChcKSTMd.js";const D="https://64.227.15.111/ventas",se=async()=>(await $.get(D)).data,re=async g=>(await $.post(D,g)).data,ue=async g=>(await $.get(`${D}/${g}/detalle`)).data,ce={class:"ventas-card"},me={class:"p-4"},fe={class:"ventas-form-header"},ve={class:"ventas-form-col"},pe={class:"ventas-form-col justify-center"},_e={key:0,class:"error-text"},be={key:1,class:"info-text"},Ve={class:"imei-cell"},ge={key:1,class:"imei-seleccionado"},ye={class:"imei-value"},he={class:"p-mt-4"},Ie={class:"p-mt-4"},ke={key:0,class:"p-mt-4"},Ce={__name:"Ventas",setup(g){const c=ee(),U=new Date().toISOString().slice(0,10),S=p([]),b=p([]),N=p([]),I=p(null),E=p([]),x=p([]),k=p(!1),o=ae({cliente_id:null,fecha:U,observaciones:"",articulos:[]}),L=R(()=>o.articulos.reduce((t,a)=>t+a.cantidad*a.precio_unitario,0)),G=R(()=>{const t={};return x.value.forEach(a=>{t[a.articulo_nombre]||(t[a.articulo_nombre]=[]),t[a.articulo_nombre].push(a)}),Object.entries(t).map(([a,e])=>({articulo_nombre:a,cantidad:e.length,imeis:e}))});function v(t,a=null){const e=b.value.find(f=>f.id===t);if(!e)return 0;const n=G.value.find(f=>f.articulo_nombre===e.nombre),s=n?n.cantidad:0,Y=o.articulos.filter(f=>f.articulo_id===t&&(!a||f!==a)).reduce((f,Z)=>f+Z.cantidad,0);return s-Y}function M(t=null){return b.value.filter(a=>{const e=v(a.id,t);return t&&t.articulo_id===a.id?!0:e>0})}function B(t,a=null){const e=b.value.find(s=>s.id===t);if(!e)return[];const n=o.articulos.filter(s=>s.articulo_id===t&&s.imei&&s!==a).map(s=>s.imei);return x.value.filter(s=>s.articulo_nombre===e.nombre&&s.status==="Disponible"&&!n.includes(s.imei))}function m(t){return B(t).length>0}function z(){o.articulos.push({articulo_id:null,cantidad:1,precio_unitario:0,imei:null})}function H(t){o.articulos.splice(t,1)}function J(t){if(m(t.articulo_id))t.cantidad=1;else{const a=v(t.articulo_id,t);t.cantidad>a&&(t.cantidad=a),t.cantidad<1&&(t.cantidad=1)}}function K(t,a){const e=b.value.find(n=>n.id===t);e&&(a.precio_unitario=Number(e.precioVenta)||0,a.cantidad=(m(t),1),a.imei=null)}async function Q(){S.value=await de()}async function F(){const t=await fetch("https://64.227.15.111/articulos/todos");b.value=await t.json()}async function j(){x.value=await ie()}async function q(){N.value=await se()}async function W(){if(!S.value.some(a=>a.id===o.cliente_id)){c.add({severity:"error",summary:"Cliente inválido",detail:"Selecciona un cliente válido.",life:4e3});return}for(const a of o.articulos){if(!b.value.find(n=>n.id===a.articulo_id)){c.add({severity:"error",summary:"Artículo inválido",detail:"Selecciona un artículo válido.",life:4e3});return}if(a.cantidad>v(a.articulo_id,a)){c.add({severity:"error",summary:"Stock insuficiente",detail:"No hay suficiente stock para el artículo seleccionado.",life:4e3});return}if(m(a.articulo_id)){if(!a.imei){c.add({severity:"error",summary:"IMEI requerido",detail:"Selecciona un IMEI para este artículo.",life:4e3});return}const n=o.articulos.filter(s=>s.imei).map(s=>s.imei);if(new Set(n).size!==n.length){c.add({severity:"error",summary:"IMEI duplicado",detail:"No puedes vender el mismo IMEI dos veces.",life:4e3});return}}}try{const a=o.articulos.map(e=>m(e.articulo_id)?{articulo_id:e.articulo_id,cantidad:1,precio_unitario:e.precio_unitario,imei:e.imei}:{articulo_id:e.articulo_id,cantidad:e.cantidad,precio_unitario:e.precio_unitario});await re({...o,total:L.value,articulos:a}),k.value=!0,c.add({severity:"success",summary:"Venta registrada",life:3e3}),o.cliente_id=null,o.observaciones="",o.articulos=[],await j(),await F(),await q()}catch(a){c.add({severity:"error",summary:"Error al guardar",detail:a.message,life:4e3})}}async function X(t){var e,n;const a=((e=t.data)==null?void 0:e.id)||((n=I.value)==null?void 0:n.id);a&&(E.value=await ue(a))}return te(()=>{Q(),F(),j(),q()}),(t,a)=>(V(),y("div",ce,[d("div",me,[a[11]||(a[11]=d("h2",null,"Registrar Nota de Venta",-1)),d("div",fe,[d("div",ve,[a[6]||(a[6]=d("label",{class:"mb-2"},"Cliente",-1)),l(i(A),{modelValue:o.cliente_id,"onUpdate:modelValue":a[0]||(a[0]=e=>o.cliente_id=e),options:S.value,optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona un cliente",class:"w-full"},null,8,["modelValue","options"])]),d("div",pe,[a[7]||(a[7]=d("label",null,"Fecha",-1)),l(i(T),{modelValue:o.fecha,"onUpdate:modelValue":a[1]||(a[1]=e=>o.fecha=e),value:i(U),readonly:"",class:"fecha-input"},null,8,["modelValue","value"])])]),a[12]||(a[12]=d("h3",null,"Artículos",-1)),l(i(w),{value:o.articulos,responsiveLayout:"scroll",class:"venta-articulos-table"},{default:u(()=>[l(i(r),{header:"Artículo"},{body:u(e=>[l(i(A),{modelValue:e.data.articulo_id,"onUpdate:modelValue":n=>e.data.articulo_id=n,options:M(e.data),optionLabel:"nombre",optionValue:"id",placeholder:"Selecciona artículo",class:"w-full",onChange:n=>K(e.data.articulo_id,e.data),disabled:M(e.data).length===0},null,8,["modelValue","onUpdate:modelValue","options","onChange","disabled"])]),_:1}),l(i(r),{header:"Stock"},{body:u(e=>[O(_(v(e.data.articulo_id,e.data)),1)]),_:1}),l(i(r),{field:"cantidad",header:"Cantidad"},{body:u(e=>[l(i(T),{type:"number",modelValue:e.data.cantidad,"onUpdate:modelValue":n=>e.data.cantidad=n,modelModifiers:{number:!0},min:1,max:m(e.data.articulo_id)?1:v(e.data.articulo_id,e.data),class:"w-full",disabled:!e.data.articulo_id||m(e.data.articulo_id),onInput:n=>J(e.data)},null,8,["modelValue","onUpdate:modelValue","max","disabled","onInput"]),e.data.cantidad>v(e.data.articulo_id,e.data)?(V(),y("small",_e," Máx: "+_(v(e.data.articulo_id,e.data)),1)):h("",!0),m(e.data.articulo_id)?(V(),y("small",be," Solo puedes vender un equipo por fila si requiere IMEI. ")):h("",!0)]),_:1}),l(i(r),{field:"precio_unitario",header:"Precio"},{body:u(e=>[d("span",null,_(e.data.precio_unitario.toFixed(2)),1)]),_:1}),l(i(r),{field:"subtotal",header:"Subtotal"},{body:u(e=>[O(_((e.data.cantidad*e.data.precio_unitario).toFixed(2)),1)]),_:1}),l(i(r),{header:"Acciones"},{body:u(e=>[l(i(C),{icon:"pi pi-trash",class:"p-button-danger p-button-sm",onClick:n=>H(e.index)},null,8,["onClick"])]),_:1}),l(i(r),{header:"IMEI"},{body:u(e=>[d("div",Ve,[m(e.data.articulo_id)?(V(),le(i(A),{key:0,modelValue:e.data.imei,"onUpdate:modelValue":n=>e.data.imei=n,options:B(e.data.articulo_id,e.data),optionLabel:"imei",optionValue:"imei",placeholder:"Selecciona IMEI",class:"w-full imei-dropdown",disabled:!e.data.articulo_id},null,8,["modelValue","onUpdate:modelValue","options","disabled"])):h("",!0),e.data.imei?(V(),y("div",ge,[a[8]||(a[8]=d("span",null,"IMEI seleccionado:",-1)),d("span",ye,_(e.data.imei),1)])):h("",!0)])]),_:1})]),_:1},8,["value"]),l(i(C),{label:"Agregar Artículo",icon:"pi pi-plus",class:"p-mt-2",onClick:z,disabled:M().length===0},null,8,["disabled"]),d("div",he,[a[9]||(a[9]=d("label",null,"Observaciones",-1)),l(i(ne),{modelValue:o.observaciones,"onUpdate:modelValue":a[2]||(a[2]=e=>o.observaciones=e),rows:"2"},null,8,["modelValue"])]),d("div",Ie,[d("strong",null,"Total: $"+_(L.value.toFixed(2)),1)]),l(i(C),{label:"Guardar Venta",class:"p-mt-4",onClick:W,disabled:!o.cliente_id||o.articulos.length===0},null,8,["disabled"]),a[13]||(a[13]=d("h2",{class:"p-mt-6"},"Ventas Registradas",-1)),l(i(w),{value:N.value,selectionMode:"single",selection:I.value,"onUpdate:selection":a[3]||(a[3]=e=>I.value=e),onRowSelect:X},{default:u(()=>[l(i(r),{field:"id",header:"ID"}),l(i(r),{field:"cliente_nombre",header:"Cliente"}),l(i(r),{field:"fecha",header:"Fecha"}),l(i(r),{field:"total",header:"Total"})]),_:1},8,["value","selection"]),E.value.length>0?(V(),y("div",ke,[d("h3",null,"Detalle de Venta #"+_(I.value.id),1),l(i(w),{value:E.value},{default:u(()=>[l(i(r),{field:"articulo_nombre",header:"Artículo"}),l(i(r),{field:"cantidad",header:"Cantidad"}),l(i(r),{field:"precio_unitario",header:"Precio"}),l(i(r),{field:"subtotal",header:"Subtotal"}),l(i(r),{field:"imei",header:"IMEI"})]),_:1},8,["value"])])):h("",!0),l(i(oe),{visible:k.value,"onUpdate:visible":a[5]||(a[5]=e=>k.value=e),header:"Venta registrada",closable:!1,modal:!0},{default:u(()=>[a[10]||(a[10]=d("p",null,"La nota de venta se registró correctamente.",-1)),l(i(C),{label:"Aceptar",icon:"pi pi-check",onClick:a[4]||(a[4]=e=>k.value=!1),autofocus:""})]),_:1},8,["visible"])])]))}},xe=P(Ce,[["__scopeId","data-v-851244f9"]]);export{xe as default};
